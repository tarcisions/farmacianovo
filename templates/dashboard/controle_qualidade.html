{% extends 'base.html' %}

{% block title %}Controle de Qualidade{% endblock %}

{% block content %}
<div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 fw-bold"><i class="bi bi-clipboard-check text-primary"></i> Controle de Qualidade</h1>
        <small class="text-muted">Total de formulários: <strong>{{ total_formularios }}</strong></small>
    </div>
    <a href="{% url 'dashboard:controle_qualidade_novo' %}" class="btn btn-success btn-lg">
        <i class="bi bi-plus-circle"></i> Novo Formulário
    </a>
</div>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard:funcionario' %}">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Controle de Qualidade</li>
    </ol>
</nav>

<!-- Filtros -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-secondary text-white">
        <strong><i class="bi bi-funnel"></i> Filtros</strong>
    </div>
    <div class="card-body">
        <form method="get" id="filtros-form">
            <div class="row g-2">
                <div class="col-md-3">
                    <input 
                        type="text" 
                        class="form-control form-control-sm" 
                        placeholder="Nome ou código..."
                        name="nome" 
                        value="{{ filtros.nome }}"
                    >
                </div>

                <div class="col-md-3">
                    <div class="autocomplete-container">
                        <input 
                            type="text" 
                            class="form-control form-control-sm" 
                            id="filtro-funcionario"
                            placeholder="Nome do funcionário..."
                            name="funcionario" 
                            value="{{ filtros.funcionario }}"
                            autocomplete="off"
                        >
                        <ul class="autocomplete-list" id="autocomplete-list"></ul>
                    </div>
                </div>

                <div class="col-md-2">
                    <input 
                        type="date" 
                        class="form-control form-control-sm" 
                        name="data_inicio" 
                        value="{{ filtros.data_inicio }}"
                    >
                </div>

                <div class="col-md-2">
                    <input 
                        type="date" 
                        class="form-control form-control-sm" 
                        name="data_fim" 
                        value="{{ filtros.data_fim }}"
                    >
                </div>

                <div class="col-md-1 d-flex gap-1">
                    <button type="submit" class="btn btn-primary btn-sm" title="Buscar">
                        <i class="bi bi-search"></i>
                    </button>
                    <a href="{% url 'dashboard:controle_qualidade' %}" class="btn btn-secondary btn-sm" title="Limpar filtros">
                        <i class="bi bi-arrow-clockwise"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    .autocomplete-container {
        position: relative;
    }

    .autocomplete-list {
        list-style: none;
        padding: 0;
        margin: 0;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .autocomplete-list.active {
        display: block;
    }

    .autocomplete-list li {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.9rem;
    }

    .autocomplete-list li:hover,
    .autocomplete-list li.selected {
        background-color: #e7f3ff;
    }

    .autocomplete-list li:last-child {
        border-bottom: none;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const funcionarioInput = document.getElementById('filtro-funcionario');
    const autocompleteList = document.getElementById('autocomplete-list');
    const filtrosForm = document.getElementById('filtros-form');
    let timeoutId;

    // Autocomplete para funcionário
    funcionarioInput.addEventListener('input', function() {
        clearTimeout(timeoutId);
        const valor = this.value.trim();

        if (valor.length < 1) {
            autocompleteList.classList.remove('active');
            return;
        }

        timeoutId = setTimeout(function() {
            // Dados dos funcionários que vem do servidor
            const jsonStr = '{{ funcionarios_json|safe }}';
            let funcionarios = [];
            
            if (jsonStr && jsonStr.length > 0) {
                try {
                    funcionarios = JSON.parse(jsonStr);
                } catch (e) {
                    funcionarios = [];
                }
            }
            
            // Filtrar funcionários que contêm o texto digitado
            const resultados = funcionarios.filter(f => 
                f && f.nome && f.nome.toLowerCase().includes(valor.toLowerCase())
            );

            // Limpar lista
            autocompleteList.innerHTML = '';

            if (resultados.length === 0) {
                autocompleteList.classList.remove('active');
                return;
            }

            // Adicionar resultados
            resultados.forEach(f => {
                const li = document.createElement('li');
                li.textContent = f.nome;
                li.dataset.valor = f.nome;
                
                li.addEventListener('click', function(e) {
                    e.preventDefault();
                    funcionarioInput.value = f.nome;
                    autocompleteList.classList.remove('active');
                });

                autocompleteList.appendChild(li);
            });

            autocompleteList.classList.add('active');
        }, 300);
    });

    // Fechar autocomplete ao clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.autocomplete-container')) {
            autocompleteList.classList.remove('active');
        }
    });

    // Permitir navegação no autocomplete com setas
    funcionarioInput.addEventListener('keydown', function(e) {
        const items = autocompleteList.querySelectorAll('li');
        let selected = autocompleteList.querySelector('li.selected');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextItem = selected ? selected.nextElementSibling : items[0];
            if (nextItem) {
                if (selected) selected.classList.remove('selected');
                nextItem.classList.add('selected');
                nextItem.scrollIntoView({ block: 'nearest' });
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const prevItem = selected ? selected.previousElementSibling : items[items.length - 1];
            if (prevItem) {
                if (selected) selected.classList.remove('selected');
                prevItem.classList.add('selected');
                prevItem.scrollIntoView({ block: 'nearest' });
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selected) {
                funcionarioInput.value = selected.dataset.valor;
                autocompleteList.classList.remove('active');
                selected.classList.remove('selected');
            } else {
                filtrosForm.submit();
            }
        }
    });
});
</script>
<div class="card shadow-sm">
    <div class="card-header bg-info text-white">
        <span><strong><i class="bi bi-table"></i> Formulários de Controle de Qualidade</strong></span>
    </div>
    <div class="card-body">
        {% if formularios %}
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 60px;">#</th>
                            <th>Nome do Item</th>
                            <th>Código</th>
                            <th>Funcionário</th>
                            <th class="text-center">Respostas</th>
                            <th>Data de Preenchimento</th>
                            <th class="text-center" style="width: 80px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for formulario in formularios %}
                        <tr>
                            <td class="text-center text-muted">
                                <small>{{ formulario.id }}</small>
                            </td>
                            <td>{{ formulario.nome_item }}</td>
                            <td>
                                {% if formulario.codigo_item %}
                                    <span class="badge bg-secondary">{{ formulario.codigo_item }}</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <i class="bi bi-person-circle"></i> 
                                <strong>{{ formulario.funcionario.get_full_name|default:formulario.funcionario.username }}</strong>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-primary">{{ formulario.respostas.count }}</span>
                            </td>
                            <td>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i>
                                    {{ formulario.preenchido_em|date:"d/m/Y H:i" }}
                                </small>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a href="{% url 'dashboard:controle_qualidade_detalhe' formulario.id %}" class="btn btn-sm btn-outline-info" title="Ver detalhes">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if formularios.has_other_pages %}
            <nav aria-label="Paginação" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if formularios.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1">Primeira</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ formularios.previous_page_number }}">Anterior</a>
                        </li>
                    {% endif %}

                    {% for num in formularios.paginator.page_range %}
                        {% if formularios.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if formularios.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ formularios.next_page_number }}">Próxima</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ formularios.paginator.num_pages }}">Última</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <i class="bi bi-inbox display-4 text-muted opacity-50"></i>
                <p class="text-muted mt-3">
                    <strong>{% if is_gerente %}Nenhum formulário preenchido ainda{% else %}Você ainda não preencheu nenhum formulário{% endif %}</strong>
                    <br>
                    <small>
                        Clique em "Novo Formulário" para começar a preencher um.
                    </small>
                </p>
                <a href="{% url 'dashboard:controle_qualidade_novo' %}" class="btn btn-success mt-3">
                    <i class="bi bi-plus-circle"></i> Criar Novo Formulário
                </a>
            </div>
        {% endif %}
    </div>
</div>

<style>
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
</style>

{% endblock %}
