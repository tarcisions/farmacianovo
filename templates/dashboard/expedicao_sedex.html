
{% extends 'base.html' %}

{% block title %}Expedição - Envio Sedex{% endblock %}


{% block content %}
<div class="mb-4">
    <h1 class="h3 fw-bold"><i class="bi bi-box-seam text-primary"></i> Organizar Envios - Sedex</h1>
</div>

<!-- Exibir Configuração do Gestor -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            {% if config_sedex.tipo_pontuacao_sedex == 'por_dia' %}
            <strong>Modo Sedex:</strong> Pontuação por dia
            {% else %}
            <strong>Modo Sedex:</strong> Pontuação por envio
            {% endif %}
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Pedidos Disponíveis -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <strong>Pedidos Disponíveis na Expedição</strong>
                <span class="badge bg-white text-primary float-end">{{ pedidos_disponiveis.count }}</span>
            </div>
            <div class="card-body p-0">
                {% if pedidos_disponiveis %}
                <form method="post" id="form-pedidos-sedex">
                    {% csrf_token %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <input type="checkbox" id="select-all-sedex" class="form-check-input" 
                                               onclick="toggleAllCheckboxes(this, 'select-pedido-sedex')">
                                    </th>
                                    <th>ID</th>
                                    <th>IDPEDIDO</th>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Qtd</th>
                                    <th width="120">Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pedido in pedidos_disponiveis %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="pedidos_selecionados" value="{{ pedido.id }}" 
                                               class="form-check-input select-pedido-sedex"
                                               onchange="updateSelectAll('select-all-sedex', 'select-pedido-sedex')">
                                    </td>
                                    <td><strong class="text-primary">{{ pedido.nrorc }}</strong></td>
                                    <td><code class="text-muted">{{ pedido.id_pedido_api|default:"-" }}</code></td>
                                    <td><small style="word-wrap: break-word; white-space: normal; max-width: 200px; display: inline-block;">{{ pedido.nome }}</small></td>
                                    <td>
                                        {% if pedido.tipo_identificado %}
                                        <span class="badge bg-info">{{ pedido.tipo_identificado }}</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-light text-dark">{{ pedido.quantidade }}</span></td>
                                    <td>
                                        <button type="submit" name="acao" value="adicionar_individual" 
                                                class="btn btn-sm btn-success" title="Adicionar este pedido ao envio"
                                                onclick="document.getElementById('pedido-individual-sedex').value='{{ pedido.id }}'; return true;">
                                            <i class="bi bi-plus-circle"></i> Adicionar
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Ações em lote -->
                    {% if pedidos_disponiveis %}
                    <div class="p-3 border-top bg-light d-flex gap-2 flex-wrap">
                        <button type="button" id="btn-toggle-select" class="btn btn-secondary" onclick="toggleSelectAll('select-all-sedex', 'select-pedido-sedex');">
                            <i class="bi bi-check2-square"></i> <span id="toggle-text">Selecionar Tudo</span>
                        </button>
                        <button type="submit" name="acao" value="adicionar_selecionados" id="btn-adicionar" class="btn btn-success" disabled style="pointer-events: none; opacity: 0.5;">
                            <i class="bi bi-check-circle"></i> Adicionar Selecionados ao Envio
                        </button>
                        <button type="submit" name="acao" value="remover_expedicao_lote" id="btn-voltar-link" class="btn btn-warning" disabled style="pointer-events: none; opacity: 0.5;">
                            <i class="bi bi-x-circle"></i> Remover Expedição
                        </button>
                    </div>
                    {% endif %}
                    
                    <input type="hidden" id="pedido-individual-sedex" name="pedido_id" value="">
                </form>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-inbox display-4"></i>
                    <p class="mt-2">Nenhum pedido disponível<br><small>Todos os seus pedidos já estão em montagem!</small></p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Resumo do Sedex -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <strong><i class="bi bi-box-seam"></i> Envio em Montagem</strong>
                {% if pedidos_selecionados %}
                <span class="badge bg-white text-success">{{ pedidos_selecionados.count }}</span>
                {% endif %}
            </div>
            <div class="card-body">
                {% if pedidos_selecionados %}
                <div class="alert alert-success mb-3">
                    <div>
                        <strong>Pedidos selecionados:</strong>
                        <span class="badge bg-success">{{ pedidos_selecionados.count }}</span>
                    </div>
                    {% if config_sedex.tipo_pontuacao_sedex == 'por_dia' and sedex_processado_hoje %}
                    <div class="mt-2">
                        <small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Já processado hoje (modo por dia)</small>
                    </div>
                    {% endif %}
                </div>

                <div class="list-group mb-3" style="max-height: 350px; overflow-y: auto;">
                    {% for pedido in pedidos_selecionados %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <strong class="text-primary">{{ pedido.nrorc }}</strong>
                                <code class="text-muted ms-2">{{ pedido.id_pedido_api|default:"-" }}</code>
                                <br>
                                <small class="text-muted" style="word-wrap: break-word; white-space: normal; max-width: 200px; display: inline-block;">{{ pedido.nome }}</small>
                                <br>
                                <small>
                                    {% if pedido.tipo_identificado %}
                                    <span class="badge bg-info">{{ pedido.tipo_identificado }}</span>
                                    {% endif %}
                                    <span class="ms-2">Qtd: {{ pedido.quantidade }}</span>
                                </small>
                            </div>
                            <div class="d-flex gap-2">
                                <form method="post" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="acao" value="remover">
                                    <input type="hidden" name="pedido_id" value="{{ pedido.id }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Devolver para Pedidos Disponíveis">
                                        <i class="bi bi-arrow-up-circle"></i>
                                    </button>
                                </form>
                                <form method="post" style="display: inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="acao" value="remover_expedicao">
                                    <input type="hidden" name="pedido_id" value="{{ pedido.id }}">
                                    <button type="submit" class="btn btn-sm btn-outline-warning" title="Remover esta expedição (Sedex) e selecionar outra">
                                        <i class="bi bi-x-circle"></i> Remover Expedição
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <form method="post" class="mb-2">
                    {% csrf_token %}
                    <input type="hidden" name="acao" value="finalizar">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-circle"></i> Finalizar Envio
                    </button>
                </form>

                <button type="button" class="btn btn-outline-secondary w-100" data-url="{% url 'dashboard:expedicao_sedex' %}" onclick="location.href=this.getAttribute('data-url'); return false;">
                    <i class="bi bi-arrow-counterclockwise"></i> Limpar Tudo
                </button>

                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-4 text-muted opacity-50"></i>
                    <p class="text-muted mt-3">
                        <strong>Selecione pedidos</strong>
                        <br>
                        <small>para começar a montar seu envio</small>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function toggleAllCheckboxes(selectAllCheckbox, className) {
    const checkboxes = document.querySelectorAll('.' + className);
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateBtnVoltar();
}

function updateSelectAll(selectAllId, className) {
    const selectAllCheckbox = document.getElementById(selectAllId);
    const checkboxes = document.querySelectorAll('.' + className);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    selectAllCheckbox.checked = allChecked;
    updateBtnVoltar();
}

function updateBtnVoltar() {
    const checkboxes = document.querySelectorAll('input[name="pedidos_selecionados"]:checked');
    const btnLink = document.getElementById('btn-voltar-link');
    const btnAdicionar = document.getElementById('btn-adicionar');
    
    if (checkboxes.length > 0) {
        // Habilitar botões se houver algum pedido selecionado
        btnLink.removeAttribute('disabled');
        btnLink.style.pointerEvents = 'auto';
        btnLink.style.opacity = '1';
        btnLink.href = urlVoltar.semPedidos || '{% url 'dashboard:meus_pedidos' %}';
        
        btnAdicionar.removeAttribute('disabled');
        btnAdicionar.style.pointerEvents = 'auto';
        btnAdicionar.style.opacity = '1';
    } else {
        // Desabilitar botões se não houver pedidos selecionados
        btnLink.setAttribute('disabled', 'disabled');
        btnLink.style.pointerEvents = 'none';
        btnLink.style.opacity = '0.5';
        
        btnAdicionar.setAttribute('disabled', 'disabled');
        btnAdicionar.style.pointerEvents = 'none';
        btnAdicionar.style.opacity = '0.5';
    }
}

function toggleSelectAll(selectAllId, className) {
    const selectAllCheckbox = document.getElementById(selectAllId);
    const checkboxes = document.querySelectorAll('.' + className);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    // Se todos estão checados, desmarcar todos
    // Se não todos estão checados, marcar todos
    checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
    });
    
    selectAllCheckbox.checked = !allChecked;
    updateToggleText();
    updateBtnVoltar();
}

function updateToggleText() {
    const checkboxes = document.querySelectorAll('input[name="pedidos_selecionados"]');
    const checkedCount = document.querySelectorAll('input[name="pedidos_selecionados"]:checked').length;
    const toggleText = document.getElementById('toggle-text');
    
    if (checkedCount === checkboxes.length && checkboxes.length > 0) {
        toggleText.textContent = 'Desselecionar Tudo';
    } else {
        toggleText.textContent = 'Selecionar Tudo';
    }
}

// Verificar estado inicial
document.addEventListener('DOMContentLoaded', function() {
    updateToggleText();
    updateBtnVoltar();
});

// Atualizar texto quando checkbox individual muda
document.addEventListener('change', function(e) {
    if (e.target.name === 'pedidos_selecionados') {
        updateToggleText();
        updateBtnVoltar();
    }
});
</script>

{% endblock %}
