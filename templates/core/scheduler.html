{% extends 'base.html' %}
{% load static %}

{% block title %}Gerenciador de Sincroniza√ß√£o{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h1>üîÑ Sincroniza√ß√£o Autom√°tica da API</h1>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Status do Scheduler</h5>
                </div>
                <div class="card-body">
                    <div id="status-content">
                        <p class="text-muted">Carregando...</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Controles</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-success" onclick="iniciarScheduler()" id="btn-iniciar">
                        ‚ñ∂Ô∏è Iniciar
                    </button>
                    <button class="btn btn-warning" onclick="pararScheduler()" id="btn-parar">
                        ‚èπÔ∏è Parar
                    </button>
                    <button class="btn btn-primary" onclick="sincronizarAgora()" id="btn-agora">
                        üîî Sincronizar Agora
                    </button>
                    <button class="btn btn-info" onclick="recarregarStatus()">
                        üîÉ Recarregar Status
                    </button>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Configura√ß√£o Atual</h5>
                </div>
                <div class="card-body">
                    <div id="config-content">
                        <p class="text-muted">Carregando...</p>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-4">
                <h6>üìù Como Usar:</h6>
                <ul>
                    <li>Para mudar a URL, intervalo ou pagina√ß√µes, edite <code>core/scheduler.py</code></li>
                    <li>O scheduler inicia automaticamente quando voc√™ faz <code>python manage.py runserver</code></li>
                    <li>Use os bot√µes acima para controlar manualmente</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

async function fazerRequisicao(url, metodo = 'GET') {
    try {
        const opcoes = {
            method: metodo,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            }
        };
        
        const resposta = await fetch(url, opcoes);
        const dados = await resposta.json();
        
        if (dados.sucesso) {
            mostrarNotificacao(dados.mensagem || 'Sucesso!', 'success');
        } else {
            mostrarNotificacao(dados.erro || 'Erro desconhecido', 'danger');
        }
        
        recarregarStatus();
        return dados;
    } catch (erro) {
        mostrarNotificacao('Erro na requisi√ß√£o: ' + erro, 'danger');
    }
}

async function iniciarScheduler() {
    await fazerRequisicao('{% url "core:scheduler_iniciar" %}', 'POST');
}

async function pararScheduler() {
    await fazerRequisicao('{% url "core:scheduler_parar" %}', 'POST');
}

async function sincronizarAgora() {
    await fazerRequisicao('{% url "core:scheduler_sincronizar" %}', 'POST');
}

async function recarregarStatus() {
    try {
        const resposta = await fetch('{% url "core:scheduler_status" %}');
        const dados = await resposta.json();
        
        if (dados.sucesso) {
            // Atualizar status
            const scheduler = dados.scheduler;
            let statusHTML = `
                <div class="alert ${scheduler.ativo ? 'alert-success' : 'alert-warning'}">
                    <strong>Status: ${scheduler.ativo ? '‚úì ATIVO' : '‚úó INATIVO'}</strong>
                </div>
            `;
            
            if (scheduler.jobs && scheduler.jobs.length > 0) {
                statusHTML += '<h6>Jobs Agendados:</h6>';
                scheduler.jobs.forEach(job => {
                    statusHTML += `
                        <div class="mb-3">
                            <strong>${job.nome}</strong><br>
                            <small class="text-muted">
                                ID: ${job.id}<br>
                                Pr√≥xima execu√ß√£o: ${new Date(job.proxima_execucao).toLocaleString('pt-BR')}<br>
                                Intervalo: ${job.intervalo}
                            </small>
                        </div>
                    `;
                });
            }
            
            document.getElementById('status-content').innerHTML = statusHTML;
            
            // Atualizar configura√ß√£o
            const config = dados.configuracao;
            let configHTML = `
                <dl>
                    <dt>URL Base:</dt>
                    <dd><code>${config.url_base}</code></dd>
                    
                    <dt>Intervalo:</dt>
                    <dd>${config.intervalo_minutos} minuto(s)</dd>
                    
                    <dt>Ativo:</dt>
                    <dd>${config.ativo ? '‚úì Sim' : '‚úó N√£o'}</dd>
                    
                    <dt>Pagina√ß√µes:</dt>
                    <dd>
                        <ul>
            `;
            
            config.paginacoes.forEach(pag => {
                configHTML += `<li>P√°gina ${pag.pagina}, Tamanho ${pag.tamanho}</li>`;
            });
            
            configHTML += `
                        </ul>
                    </dd>
                </dl>
            `;
            
            document.getElementById('config-content').innerHTML = configHTML;
        }
    } catch (erro) {
        console.error('Erro ao carregar status:', erro);
    }
}

function mostrarNotificacao(mensagem, tipo) {
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
    alerta.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alerta, container.firstChild);
    
    setTimeout(() => alerta.remove(), 5000);
}

// Carregar status ao abrir a p√°gina
document.addEventListener('DOMContentLoaded', recarregarStatus);

// Atualizar status a cada 30 segundos
setInterval(recarregarStatus, 30000);
</script>

<style>
code {
    background-color: #f4f4f4;
    padding: 2px 6px;
    border-radius: 3px;
}
</style>
{% endblock %}
